{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <title>Video Kyc</title>
        <script src="https://webrtc.github.io/adapter/adapter-4.2.2.js" integrity=""></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>

    <body>
        {% block nav %} {% include 'accounts/userNav.html' %} {% endblock %}
        <p>This is room <span id="roomUrl"></span></p>
        <div id="remotes" class="row">
            <div class="col-md-6">
              <div class="videoContainer">
                <video id="selfVideo" oncontextmenu="return false;"></video>
                <meter id="localVolume" class="volume" min="-45" max="-20" high="-25" low="-40"></meter>
              </div>
            </div>
        </div>
        <script src="{% static "accounts/simplewebrtc.js" %}" integrity=""></script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                var webrtc = new SimpleWebRTC({
                    localVideoEl: "selfVideo",
                    // the id/element dom element that will hold remote videos
                    remoteVideosEl: "",
                    autoRequestMedia: true,
                    debug: false,
                    detectSpeakingEvents: true,
                    autoAdjustMic: false
                });
            
                // Set the publicly available room URL.
                document.getElementById("roomUrl").innerText = window.location.pathname;
                
                // Immediately join room when loaded.
                webrtc.on("readyToCall", function() {
                    webrtc.joinRoom(location.pathname);
                });
            
                function showVolume(el, volume) {
                    if (!el) return;
                    if (volume < -45) volume = -45; // -45 to -20 is
                    if (volume > -20) volume = -20; // a good range
                    el.value = volume;
                }
            
                // Display the volume meter.
                webrtc.on("localStream", function(stream) {
                    var button = document.querySelector("form>button");
                    if (button) button.removeAttribute("disabled");
                    document.getElementById("localVolume").style.display = "block";
                });
            
                // If we didn't get access to the camera, raise an error.
                webrtc.on("localMediaError", function (err) {
                    alert("This service only works if you allow camera access.Please grant access and refresh the page.");
                });
            
                // When another person joins the chat room, we'll display their video.
                webrtc.on("videoAdded", function(video, peer) {
                    console.log("user added to chat", peer);
                    var remotes = document.getElementById("remotes");
            
                    if (remotes) {
                    var outerContainer = document.createElement("div");
                    outerContainer.className = "col-md-6";
            
                    var container = document.createElement("div");
                    container.className = "videoContainer";
                    container.id = "container_" + webrtc.getDomId(peer);
                    container.appendChild(video);
            
                    // Suppress right-clicks on the video.
                    video.oncontextmenu = function() { return false; };
            
                    // Show the volume meter.
                    var vol = document.createElement("meter");
                    vol.id = "volume_" + peer.id;
                    vol.className = "volume";
                    vol.min = -45;
                    vol.max = -20;
                    vol.low = -40;
                    vol.high = -25;
                    container.appendChild(vol);
            
                    // Show the connection state.
                    if (peer && peer.pc) {
                        var connstate = document.createElement("div");
                        connstate.className = "connectionstate";
                        container.appendChild(connstate);
            
                        peer.pc.on("iceConnectionStateChange", function(event) {
                        switch (peer.pc.iceConnectionState) {
                            case "checking":
                            connstate.innerText = "connecting to peer...";
                            break;
                            case "connected":
                            case "completed": // on caller side
                            vol.style.display = "block";
                            connstate.innerText = "connection established";
                            break;
                            case "disconnected":
                            connstate.innerText = "disconnected";
                            break;
                            case "failed":
                            connstate.innerText = "connection failed";
                            break;
                            case "closed":
                            connstate.innerText = "connection closed";
                            break;
                        }
                        });
                    }
            
                    outerContainer.appendChild(container);
                    remotes.appendChild(outerContainer);
            
                    // If we're adding a new video we need to modify bootstrap so we
                    // only get two videos per row.
                    var remoteVideos = document.getElementById("remotes").getElementsByTagName("video").length;
            
                    if (!(remoteVideos % 2)) {
                        var spacer = document.createElement("div");
                        spacer.className = "w-100";
                        remotes.appendChild(spacer);
                    }
                    }
                });
            
                // If a user disconnects from chat, we need to remove their video feed.
                webrtc.on("videoRemoved", function(video, peer) {
                    console.log("user removed from chat", peer);
                    var remotes = document.getElementById("remotes");
                    var el = document.getElementById("container_" + webrtc.getDomId(peer));
                    if (remotes && el) {
                    remotes.removeChild(el.parentElement);
                    }
                });
            
                // If our volume has changed, update the meter.
                webrtc.on("volumeChange", function(volume, treshold) {
                    showVolume(document.getElementById("localVolume"), volume);
                });
            
                // If a remote user's volume has changed, update the meter.
                webrtc.on("remoteVolumeChange", function(peer, volume) {
                    showVolume(document.getElementById("volume_" + peer.id), volume);
                });
            
                // If there is a P2P failure, we need to error out.
                webrtc.on("iceFailed", function(peer) {
                    var connstate = document.querySelector("#container_" + webrtc.getDomId(peer) + " .connectionstate");
                    console.log("local fail", connstate);
                    if (connstate) {
                    connstate.innerText = "connection failed";
                    fileinput.disabled = "disabled";
                    }
                });
            
                // remote p2p/ice failure
                webrtc.on("connectivityError", function (peer) {
                    var connstate = document.querySelector("#container_" + webrtc.getDomId(peer) + " .connectionstate");
                    console.log("remote fail", connstate);
                    if (connstate) {
                    connstate.innerText = "connection failed";
                    fileinput.disabled = "disabled";
                    }
                });
            });
        </script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </body>
</html>